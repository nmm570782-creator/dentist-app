<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Appointments Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <style>
      body { padding: 20px; }
      #calendar { max-width: 1100px; margin: 0 auto; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 m-0">Appointments</h1>
        <div class="d-flex gap-2">
          <button id="btnNew" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newAppointmentModal">New Appointment</button>
          <a class="btn btn-outline-secondary" href="/health">Health</a>
        </div>
      </div>
      <div id="calendar"></div>
    </div>

    <!-- New Appointment Modal -->
    <div class="modal fade" id="newAppointmentModal" tabindex="-1" aria-labelledby="newAppointmentLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="newAppointmentLabel">New Appointment</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="appointmentForm" class="vstack gap-3">
              <div>
                <label for="patient_name" class="form-label">Patient Name</label>
                <input type="text" id="patient_name" name="patient_name" class="form-control" required />
              </div>
              <div>
                <label for="patient_phone" class="form-label">Patient Phone</label>
                <input type="text" id="patient_phone" name="patient_phone" class="form-control" required />
              </div>
              <div>
                <label for="start_time" class="form-label">Start Time</label>
                <input type="datetime-local" id="start_time" name="start_time" class="form-control" required />
              </div>
              <div>
                <label for="end_time" class="form-label">End Time</label>
                <input type="datetime-local" id="end_time" name="end_time" class="form-control" required />
              </div>
              <div class="text-danger small" id="formError" style="display:none;"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" id="btnDelete" class="btn btn-outline-danger d-none">Delete</button>
            <button type="button" id="btnUpdate" class="btn btn-warning d-none">Update</button>
            <button type="button" id="submitAppointment" class="btn btn-primary">Create</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
      // Fetch appointments and map to FullCalendar events
      async function fetchEvents(info, successCallback, failureCallback) {
        try {
          const res = await fetch('/appointments');
          if (!res.ok) throw new Error('Failed to load appointments');
          const data = await res.json();
          const events = data.map(a => ({
            id: String(a.id),
            title: `${a.patient_name} (${a.source})`,
            start: a.start_time,
            end: a.end_time,
            extendedProps: {
              patientPhone: a.patient_phone,
              source: a.source
            }
          }));
          successCallback(events);
        } catch (err) {
          console.error(err);
          failureCallback(err);
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridDay,timeGridWeek,dayGridMonth'
          },
          height: 'auto',
          nowIndicator: true,
          slotMinTime: '06:00:00',
          slotMaxTime: '21:00:00',
          events: fetchEvents,
          eventClick: function(info) {
            const e = info.event;
            enterViewMode({
              id: e.id,
              patient_name: e.title.replace(/\s*\([^)]*\)\s*$/, ''),
              patient_phone: e.extendedProps.patientPhone || '',
              start: e.start,
              end: e.end
            });
          }
        });
        calendar.render();

        // Modal form handling
        const modalEl = document.getElementById('newAppointmentModal');
        const modal = new bootstrap.Modal(modalEl);
        const form = document.getElementById('appointmentForm');
        const errorEl = document.getElementById('formError');
        const submitBtn = document.getElementById('submitAppointment');
        const btnUpdate = document.getElementById('btnUpdate');
        const btnDelete = document.getElementById('btnDelete');
        const titleEl = document.getElementById('newAppointmentLabel');

        let currentEventId = null;

        function setInputsDisabled(disabled) {
          document.getElementById('patient_name').disabled = disabled;
          document.getElementById('patient_phone').disabled = disabled;
          document.getElementById('start_time').disabled = disabled;
          document.getElementById('end_time').disabled = disabled;
        }

        function toLocalInputValue(date) {
          if (!date) return '';
          const pad = (n) => String(n).padStart(2, '0');
          const yyyy = date.getFullYear();
          const mm = pad(date.getMonth() + 1);
          const dd = pad(date.getDate());
          const hh = pad(date.getHours());
          const mi = pad(date.getMinutes());
          return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
        }

        function enterCreateMode() {
          titleEl.textContent = 'New Appointment';
          form.reset();
          errorEl.style.display = 'none';
          submitBtn.classList.remove('d-none');
          btnUpdate.classList.add('d-none');
          btnDelete.classList.add('d-none');
          setInputsDisabled(false);
          currentEventId = null;
        }

        function enterViewMode({ id, patient_name, patient_phone, start, end }) {
          titleEl.textContent = 'Appointment Details';
          errorEl.style.display = 'none';
          document.getElementById('patient_name').value = patient_name || '';
          document.getElementById('patient_phone').value = patient_phone || '';
          document.getElementById('start_time').value = toLocalInputValue(new Date(start));
          document.getElementById('end_time').value = toLocalInputValue(new Date(end));
          setInputsDisabled(true);
          submitBtn.classList.add('d-none');
          btnUpdate.classList.remove('d-none');
          btnDelete.classList.remove('d-none');
          currentEventId = id;
          modal.show();
        }

        // Ensure New button opens in create mode
        document.getElementById('btnNew').addEventListener('click', () => {
          enterCreateMode();
        });

        function toIsoFromLocal(localValue) {
          // localValue like "2025-10-06T14:30"
          if (!localValue) return '';
          const dt = new Date(localValue);
          // Use the local time components to preserve what user selected
          const pad = (n) => String(n).padStart(2, '0');
          const yyyy = dt.getFullYear();
          const mm = pad(dt.getMonth() + 1);
          const dd = pad(dt.getDate());
          const hh = pad(dt.getHours());
          const mi = pad(dt.getMinutes());
          const ss = pad(dt.getSeconds());
          return `${yyyy}-${mm}-${dd}T${hh}:${mi}:${ss}`; // no timezone suffix
        }

        submitBtn.addEventListener('click', async () => {
          errorEl.style.display = 'none';
          errorEl.textContent = '';

          const patient_name = document.getElementById('patient_name').value.trim();
          const patient_phone = document.getElementById('patient_phone').value.trim();
          const start_time_local = document.getElementById('start_time').value;
          const end_time_local = document.getElementById('end_time').value;

          if (!patient_name || !patient_phone || !start_time_local || !end_time_local) {
            errorEl.textContent = 'Please fill in all fields.';
            errorEl.style.display = 'block';
            return;
          }

          const payload = {
            patient_name,
            patient_phone,
            start_time: toIsoFromLocal(start_time_local),
            end_time: toIsoFromLocal(end_time_local),
            source: 'web'
          };

          submitBtn.disabled = true;
          try {
            const res = await fetch('/appointments', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || 'Failed to create appointment');
            }
            // Success: close modal and refresh calendar
            form.reset();
            modal.hide();
            calendar.refetchEvents();
          } catch (e) {
            errorEl.textContent = e.message || String(e);
            errorEl.style.display = 'block';
          } finally {
            submitBtn.disabled = false;
          }
        });

        // Placeholder actions for Update/Delete (UI only for now)
        btnUpdate.addEventListener('click', () => {
          // Future: enable edit mode or navigate to edit
          // For now, keep fields readonly per requirements
        });
        btnDelete.addEventListener('click', async () => {
          if (!currentEventId) return;
          btnDelete.disabled = true;
          errorEl.style.display = 'none';
          errorEl.textContent = '';
          try {
            const res = await fetch(`/appointments/${currentEventId}`, { method: 'DELETE' });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || 'Failed to delete appointment');
            }
            modal.hide();
            calendar.refetchEvents();
          } catch (e) {
            errorEl.textContent = e.message || String(e);
            errorEl.style.display = 'block';
          } finally {
            btnDelete.disabled = false;
          }
        });
      });
    </script>
  </body>
  </html>
